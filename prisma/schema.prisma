generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Assignment {
  id                   String    @id @default(cuid())
  projectId            String
  userId               String
  role                 String?
  startDate            DateTime
  endDate              DateTime?
  allocationPercentage Int       @default(100)
  User                 User      @relation(fields: [userId], references: [id])
  Project              Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model AuditLog {
  id         String   @id @default(cuid())
  actorId    String?
  actorEmail String?
  action     String
  resource   String
  resourceId String?
  before     String?
  after      String?
  diff       String?   // JSON Patch or structured changes
  ip         String?
  userAgent  String?
  origin     String?
  referer    String?
  requestId  String?
  meta       String?
  createdAt  DateTime @default(now())

  @@index([resource, resourceId])
  @@index([actorId])
  @@index([createdAt])
  @@index([requestId])
}

model Contract {
  id        String    @id @default(cuid())
  title     String
  status    String    @default("draft")
  tenantId  String
  startDate DateTime
  endDate   DateTime?
  value     Float     @default(0)
  content   String?
  
  // Optimistic concurrency control
  version   Int       @default(1)

  // E-signature fields (real flow)
  signatureProvider    String?    // e.g., "docusign", "hellosign"
  signatureEnvelopeId  String?    // Provider's envelope/document ID
  signatureStatus      String?    // pending, signed, declined, voided
  signatureCompletedAt DateTime?
  
  // Deprecated fake signature fields (keep for migration but don't use)
  signedBy     String?
  signedAt     DateTime?
  signatureUrl String?
  
  // Soft delete
  deletedAt    DateTime?
  deletedBy    String?
  deleteReason String?

  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  Tenant    Tenant            @relation(fields: [tenantId], references: [id])
  versions  ContractVersion[]
  
  @@index([deletedAt])
  @@index([tenantId])
}

model ContractVersion {
  id         String   @id @default(cuid())
  contractId String
  version    Int
  content    String?
  status     String
  changeLog  String?
  createdAt  DateTime @default(now())
  createdBy  String?
  Contract   Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)
}

model Deployment {
  id            String      @id @default(cuid())
  environmentId String
  version       String
  status        String
  trigger       String?
  createdAt     DateTime    @default(now())
  Environment   Environment @relation(fields: [environmentId], references: [id])
}

model Environment {
  id         String       @id @default(cuid())
  name       String
  tenantId   String?
  url        String?
  createdAt  DateTime     @default(now())
  Deployment Deployment[]
  Tenant     Tenant?      @relation(fields: [tenantId], references: [id])
}

model Incident {
  id          String      @id @default(cuid())
  title       String
  severity    String
  status      String      @default("open")
  serviceId   String?
  commanderId String?
  summary     String?
  
  // Soft delete
  deletedAt    DateTime?
  deletedBy    String?
  deleteReason String?
  
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  User        User?       @relation(fields: [commanderId], references: [id])
  Service     Service?    @relation(fields: [serviceId], references: [id])
  Postmortem  Postmortem?
  
  @@index([deletedAt])
  @@index([status])
}

model Invoice {
  id          String        @id @default(cuid())
  number      String        @unique
  tenantId    String
  status      String        @default("draft")
  issueDate   DateTime
  dueDate     DateTime
  totalAmount Float
  currency    String        @default("USD")
  notes       String?
  
  // Soft delete
  deletedAt    DateTime?
  deletedBy    String?
  deleteReason String?
  
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  Tenant      Tenant        @relation(fields: [tenantId], references: [id])
  InvoiceItem InvoiceItem[]
  TimeEntry   TimeEntry[]
  
  @@index([deletedAt])
  @@index([tenantId])
  @@index([status])
}

model InvoiceSequence {
  tenantId String
  year     Int
  lastSeq  Int    @default(0)
  Tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, year])
}

model IdempotencyKey {
  key          String   @id
  userId       String
  route        String
  requestHash  String
  responseBody String
  createdAt    DateTime @default(now())
  expiresAt    DateTime
  
  @@index([userId])
  @@index([expiresAt])
}

model InvoiceItem {
  id          String  @id @default(cuid())
  invoiceId   String
  description String
  quantity    Float
  unitPrice   Float
  amount      Float
  Invoice     Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
}

model JitAccessRequest {
  id          String    @id @default(cuid())
  userId      String
  roleId      String?
  reason      String
  durationMin Int
  status      String    @default("pending")
  approvedBy  String?
  expiresAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  User        User      @relation(fields: [userId], references: [id])

  @@index([expiresAt])
  @@index([status])
}

model Lead {
  id         String   @id @default(cuid())
  name       String
  email      String
  message    String?
  source     String?
  status     String   @default("new")
  budget     String?
  role       String?
  website    String?
  assignedTo String?
  tenantId   String?
  
  // Soft delete
  deletedAt    DateTime?
  deletedBy    String?
  deleteReason String?
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  Tenant     Tenant?  @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@index([status])
  @@index([deletedAt])
}

model MediaAsset {
  id         String   @id @default(cuid())
  key        String   @unique
  url        String
  mime       String
  size       Int
  uploadedBy String?
  tenantId   String?
  
  // Private-by-default artifacts vault
  visibility          String   @default("private") // private, public, tenant
  storageKey          String?  // Actual file path or object storage key
  checksum            String?  // SHA-256 for integrity
  contentType         String?  // Explicit content type
  contentDisposition  String?  // attachment vs inline
  expiresAt           DateTime?
  
  // Soft delete
  deletedAt    DateTime?
  deletedBy    String?
  deleteReason String?
  
  createdAt  DateTime @default(now())
  
  @@index([deletedAt])
  @@index([tenantId])
  @@index([visibility])
}

model Postmortem {
  id            String          @id @default(cuid())
  incidentId    String          @unique
  rootCause     String?
  impact        String?
  remediation   String?
  content       String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  Incident      Incident        @relation(fields: [incidentId], references: [id])
  PostmortemTag PostmortemTag[]
}

model PostmortemTag {
  id           String     @id @default(cuid())
  name         String
  postmortemId String
  Postmortem   Postmortem @relation(fields: [postmortemId], references: [id], onDelete: Cascade)

  @@index([name])
}

model Project {
  id         String       @id @default(cuid())
  name       String
  tenantId   String
  status     String       @default("active")
  
  // Soft delete
  deletedAt    DateTime?
  deletedBy    String?
  deleteReason String?
  
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
  Assignment Assignment[]
  Tenant     Tenant       @relation(fields: [tenantId], references: [id])
  TimeEntry  TimeEntry[]
  
  @@index([deletedAt])
  @@index([tenantId])
}

model Proposal {
  id               String             @id @default(cuid())
  title            String
  status           String             @default("draft")
  totalAmount      Float              @default(0)
  clientEmail      String?
  content          String?
  validUntil       DateTime?
  
  // Soft delete
  deletedAt    DateTime?
  deletedBy    String?
  deleteReason String?
  
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  ProposalApproval ProposalApproval[]
  ProposalItem     ProposalItem[]
  
  @@index([deletedAt])
  @@index([status])
}

model ProposalApproval {
  id         String   @id @default(cuid())
  proposalId String
  approverId String
  status     String
  comment    String?
  createdAt  DateTime @default(now())
  User       User     @relation(fields: [approverId], references: [id])
  Proposal   Proposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)
}

model ProposalComponent {
  id             String         @id @default(cuid())
  name           String
  description    String?
  estimatedHours Float
  hourlyRate     Float
  
  // Soft delete
  deletedAt    DateTime?
  deletedBy    String?
  deleteReason String?
  
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  ProposalItem   ProposalItem[]
  
  @@index([deletedAt])
}

model ProposalItem {
  id                String             @id @default(cuid())
  proposalId        String
  componentId       String?
  customName        String?
  hours             Float
  rate              Float
  amount            Float
  ProposalComponent ProposalComponent? @relation(fields: [componentId], references: [id])
  Proposal          Proposal           @relation(fields: [proposalId], references: [id], onDelete: Cascade)
}

model RateLimit {
  key     String   @id
  count   Int      @default(0)
  resetAt DateTime
}

model Role {
  id             String           @id @default(cuid())
  name           String           @unique
  permissions    String
  RoleAssignment RoleAssignment[]
}

model RoleAssignment {
  id        String   @id @default(cuid())
  userId    String
  roleId    String
  
  // Scoped RBAC
  scopeType String   @default("GLOBAL") // GLOBAL, TENANT, PROJECT, SERVICE, REGION
  scopeId   String?  // ID of the tenant, project, service, etc.
  
  createdAt DateTime @default(now())
  Role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId, scopeType, scopeId])
  @@index([scopeType, scopeId])
}

model Service {
  id          String     @id @default(cuid())
  name        String
  description String?
  ownerId     String?
  repoUrl     String?
  lifecycle   String     @default("production")
  
  // Soft delete
  deletedAt    DateTime?
  deletedBy    String?
  deleteReason String?
  
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  Incident    Incident[]
  User        User?      @relation(fields: [ownerId], references: [id])
  
  @@index([deletedAt])
}

model Tenant {
  id              String             @id @default(cuid())
  name            String
  slug            String             @unique
  contactEmail    String?
  
  // Soft delete
  deletedAt    DateTime?
  deletedBy    String?
  deleteReason String?
  
  createdAt       DateTime           @default(now())
  Contract        Contract[]
  Environment     Environment[]
  Invoice         Invoice[]
  InvoiceSequence InvoiceSequence[]
  Lead            Lead[]
  Project         Project[]
  WebhookEndpoint WebhookEndpoint[]
  
  @@index([deletedAt])
}

model TimeEntry {
  id          String   @id @default(cuid())
  projectId   String
  userId      String
  date        DateTime
  hours       Float
  description String?
  billable    Boolean  @default(true)
  invoiceId   String?
  
  // Time tracking approvals
  status      String   @default("draft") // draft, submitted, approved, rejected
  approvedBy  String?
  approvedAt  DateTime?
  
  // Soft delete
  deletedAt    DateTime?
  deletedBy    String?
  deleteReason String?
  
  createdAt   DateTime @default(now())
  Invoice     Invoice? @relation(fields: [invoiceId], references: [id])
  User        User     @relation(fields: [userId], references: [id])
  Project     Project  @relation(fields: [projectId], references: [id])
  
  @@index([deletedAt])
  @@index([status])
  @@index([projectId])
  @@index([userId])
  @@index([invoiceId])
}

model User {
  id               String             @id @default(cuid())
  email            String             @unique
  name             String?
  passwordHash     String?
  mfaSecret        String?
  tenantId         String?
  
  // Soft delete
  deletedAt    DateTime?
  deletedBy    String?
  deleteReason String?
  
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  Assignment       Assignment[]
  Incident         Incident[]
  JitAccessRequest JitAccessRequest[]
  ProposalApproval ProposalApproval[]
  RoleAssignment   RoleAssignment[]
  Service          Service[]
  TimeEntry        TimeEntry[]
  Content          Content[]
  
  @@index([deletedAt])
}

model Content {
  id          String   @id @default(cuid())
  title       String
  slug        String   @unique
  type        String   @default("post")
  status      String   @default("draft")
  content     String?
  excerpt     String?
  authorId    String
  publishedAt DateTime?
  
  // Soft delete
  deletedAt    DateTime?
  deletedBy    String?
  deleteReason String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  User        User     @relation(fields: [authorId], references: [id])

  @@index([status])
  @@index([type])
  @@index([authorId])
  @@index([deletedAt])
}

model WebhookDelivery {
  id              String          @id @default(cuid())
  endpointId      String
  event           String
  payload         String
  status          String
  statusCode      Int?
  attempts        Int             @default(1)
  error           String?
  createdAt       DateTime        @default(now())
  WebhookEndpoint WebhookEndpoint @relation(fields: [endpointId], references: [id], onDelete: Cascade)
}

model WebhookEndpoint {
  id              String            @id @default(cuid())
  tenantId        String
  url             String
  secret          String?
  events          String
  active          Boolean           @default(true)
  createdAt       DateTime          @default(now())
  WebhookDelivery WebhookDelivery[]
  Tenant          Tenant            @relation(fields: [tenantId], references: [id])
}
