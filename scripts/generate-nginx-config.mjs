import fs from "node:fs";
import path from "node:path";
import { fileURLToPath } from "node:url";

/**
 * Vantus Systems - Nginx config generator (certbot-safe, idempotent)
 *
 * - If a Let's Encrypt certificate exists for DOMAIN, generate HTTPS + HTTP->HTTPS redirect.
 * - If no cert exists yet, generate HTTP-only config so `nginx -t` passes before certbot runs.
 *
 * Env:
 *   DEPLOY_DOMAIN  (required)
 *   DEPLOY_PORT    (default: 3000)
 *   DEPLOY_ROOT    (default: /var/www/vantus)
 */

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const PROJECT_ROOT = path.resolve(__dirname, "..");

const DOMAIN = (process.env.DEPLOY_DOMAIN || "vantus.systems").trim();
const PORT = String(process.env.DEPLOY_PORT || process.env.PORT || "3000").trim();
const ROOT_DIR = (process.env.DEPLOY_ROOT || "/var/www/vantus").trim();

const CERT_DIR = `/etc/letsencrypt/live/${DOMAIN}`;
const CERT_FULLCHAIN = `${CERT_DIR}/fullchain.pem`;
const CERT_PRIVKEY = `${CERT_DIR}/privkey.pem`;
const HAS_CERT = fs.existsSync(CERT_FULLCHAIN) && fs.existsSync(CERT_PRIVKEY);

function escapeForNginxPath(p) {
  return p.replace(/\\/g, "/");
}

function commonHttpSnippets() {
  return `
    # Basic hardening
    server_tokens off;

    # Increase if you allow larger uploads; keep aligned with app MAX_UPLOAD_SIZE
    client_max_body_size 50M;

    # Hide dotfiles
    location ~ /\\.(?!well-known).* {
        deny all;
        access_log off;
        log_not_found off;
    }

    # ACME challenge for certbot (HTTP)
    location ^~ /.well-known/acme-challenge/ {
        root /var/www/html;
        default_type "text/plain";
        allow all;
    }

    # Cache immutable Next.js assets
    location ^~ /_next/static/ {
        alias ${escapeForNginxPath(ROOT_DIR)}/.next/static/;
        access_log off;
        add_header Cache-Control "public, max-age=31536000, immutable";
        try_files $uri =404;
    }

    # Main reverse proxy to Next.js
    location / {
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSockets / upgrades
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;

        proxy_read_timeout 60s;
        proxy_connect_timeout 10s;
        proxy_send_timeout 60s;

        proxy_pass http://127.0.0.1:${PORT};
    }
`;
}

function securityHeaders(httpsMode) {
  // Keep CSP in-app (Next.js) because apps with Spline/3D often need custom CSP.
  const hsts = httpsMode
    ? `    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;\n`
    : "";
  return `
    # Security headers (baseline; adjust CSP in application)
${hsts}    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
`;
}

function buildConfig() {
  const generatedAt = new Date().toISOString();

  const preamble = `# Vantus Systems - Nginx Configuration
# Generated: ${generatedAt}
# Domain: ${DOMAIN}
# Root: ${ROOT_DIR}
# Upstream: http://127.0.0.1:${PORT}
#
# This file is generated by scripts/generate-nginx-config.mjs
# Safe for first install: emits HTTP-only until a cert exists at:
#   ${CERT_FULLCHAIN}
#   ${CERT_PRIVKEY}
`;

  const mapBlock = `
map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}
`;

  if (!HAS_CERT) {
    // HTTP-only mode
    return `${preamble}
${mapBlock}

server {
    listen 80;
    server_name ${DOMAIN};

${securityHeaders(false)}
${commonHttpSnippets()}
}

# Optional: redirect www -> apex on HTTP
server {
    listen 80;
    server_name www.${DOMAIN};
    return 301 http://${DOMAIN}$request_uri;
}
`;
  }

  // HTTPS mode
  return `${preamble}
${mapBlock}

# Redirect all HTTP to HTTPS
server {
    listen 80;
    server_name ${DOMAIN} www.${DOMAIN};

    location ^~ /.well-known/acme-challenge/ {
        root /var/www/html;
        default_type "text/plain";
        allow all;
    }

    return 301 https://${DOMAIN}$request_uri;
}

# HTTPS - Main server
server {
    listen 443 ssl http2;
    server_name ${DOMAIN};

    ssl_certificate ${CERT_FULLCHAIN};
    ssl_certificate_key ${CERT_PRIVKEY};

    # Strong TLS defaults (certbot may also manage these includes)
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers off;

${securityHeaders(true)}
${commonHttpSnippets()}
}

# HTTPS - redirect www -> apex
server {
    listen 443 ssl http2;
    server_name www.${DOMAIN};

    ssl_certificate ${CERT_FULLCHAIN};
    ssl_certificate_key ${CERT_PRIVKEY};

    return 301 https://${DOMAIN}$request_uri;
}
`;
}

const nginxConfig = buildConfig();

const configDir = path.join(PROJECT_ROOT, "config", "nginx");
if (!fs.existsSync(configDir)) {
  fs.mkdirSync(configDir, { recursive: true });
}

const outPath = path.join(configDir, "nginx.conf");
fs.writeFileSync(outPath, nginxConfig);

console.log(`‚úÖ Nginx configuration generated at ${path.relative(PROJECT_ROOT, outPath)}`);
console.log(`   Domain: ${DOMAIN}`);
console.log(`   Root: ${ROOT_DIR}`);
console.log(`   Port: ${PORT}`);
console.log(`   TLS mode: ${HAS_CERT ? "https (cert detected)" : "http-only (no cert yet)"}`);
console.log(`\nüìù Next steps (manual):`);
console.log(`   1. Copy to Nginx: sudo cp ${path.relative(process.cwd(), outPath)} /etc/nginx/sites-available/vantus.conf`);
console.log(`   2. Enable site:   sudo ln -sf /etc/nginx/sites-available/vantus.conf /etc/nginx/sites-enabled/`);
console.log(`   3. Test config:   sudo nginx -t`);
console.log(`   4. Reload Nginx:  sudo systemctl reload nginx`);
if (!HAS_CERT) {
  console.log(`   5. Setup SSL:     sudo certbot --nginx -d ${DOMAIN} -d www.${DOMAIN}`);
}
