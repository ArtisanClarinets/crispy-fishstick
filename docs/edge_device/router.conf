# /etc/nginx/conf.d/router.conf

# Websocket upgrades
map $http_upgrade $connection_upgrade {
  default upgrade;
  ''      close;
}

# If an upstream proxy (ex: Cloudflare) already provided these headers,
# keep them. Otherwise fall back to what nginx sees locally.
map $http_x_forwarded_proto $proxy_x_forwarded_proto {
  default $http_x_forwarded_proto;
  ''      $scheme;
}

map $http_x_forwarded_port $proxy_x_forwarded_port {
  default $http_x_forwarded_port;
  ''      $server_port;
}

map $http_x_forwarded_host $proxy_x_forwarded_host {
  default $http_x_forwarded_host;
  ''      $host;
}

# Safety: drop requests for unknown hosts
server {
  listen 80 default_server;
  listen [::]:80 default_server;
  server_name _;
  return 444;
}

# --- PRODUCTION: vantus.systems -> 192.168.1.169:3005 ---
upstream vantus_prod {
  server 192.168.1.169:3005;
  keepalive 32;
}

server {
  server_name vantus.systems www.vantus.systems;

  # (optional) if you upload large files
  client_max_body_size 50m;

  # Next.js static assets (explicit location helps debugging and avoids odd matches)
  location ^~ /_next/ {
    include /etc/nginx/proxy_params;

    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;

    proxy_set_header X-Forwarded-Proto $proxy_x_forwarded_proto;
    proxy_set_header X-Forwarded-Port  $proxy_x_forwarded_port;
    proxy_set_header X-Forwarded-Host  $proxy_x_forwarded_host;
    proxy_headers_hash_max_size 512;

    proxy_pass http://vantus_prod;
  }

  # Everything else
  location / {
    include /etc/nginx/proxy_params;

    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;

    proxy_set_header X-Forwarded-Proto $proxy_x_forwarded_proto;
    proxy_set_header X-Forwarded-Port  $proxy_x_forwarded_port;
    proxy_set_header X-Forwarded-Host  $proxy_x_forwarded_host;

    proxy_read_timeout 60s;
    proxy_send_timeout 60s;

    proxy_pass http://vantus_prod;
  }

    listen [::]:443 ssl ipv6only=on; # managed by Certbot
    listen 443 ssl; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/vantus.systems/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/vantus.systems/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot

}

# --- OPTIONAL: STAGING/PREVIEW hostnames -> staging machine ---
# server {
#   listen 80;
#   listen [::]:80;
#   server_name staging.example.com preview.example.com;
# 
#   location / {
#     include /etc/nginx/proxy_params;
# 
#     proxy_set_header X-Forwarded-Proto $proxy_x_forwarded_proto;
#     proxy_set_header X-Forwarded-Port  $proxy_x_forwarded_port;
#     proxy_set_header X-Forwarded-Host  $proxy_x_forwarded_host;
# 
#     proxy_pass http://192.168.1.174:80;
#   }
# }


server {
    if ($host = vantus.systems) {
        return 301 https://$host$request_uri;
    } # managed by Certbot


  listen 80;
  listen [::]:80;
  server_name vantus.systems www.vantus.systems;
    return 404; # managed by Certbot


}